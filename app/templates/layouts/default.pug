include ../mixins/flash-messages
include ../mixins/media/lightswitch

doctype html
html
    head
        //- Initial HTML configuration
        meta(charset="utf-8")
        meta(http-equiv="X-UA-Compatible" content="IE=edge")
        //- Link meta-data
        title #{global.meta.description}
        meta(name="description" content=global.meta.description)
        //- Define the viewport
        meta(name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0")
        meta(name="apple-mobile-web-app-title" content=global.meta.title)
        //- Fullscreen Safari on startup from home screen on Apple and Android devices
        //- meta(name="apple-mobile-web-app-capable" content="yes")
        //- meta(name="mobile-web-app-capable" content="yes")
        //- Link browser favicon
        link(rel="icon" type="image/png" href=global.favicon.url)
        //- Link home screen app icon on Apple devices
        link(rel="apple-touch-icon" href=global.icon.url)
        //- Link startup image on Apple devices
        link(rel="apple-touch-startup-image" href=global.startupImg.url)
        //- Link Sassafras project styles
        link(rel="stylesheet" type="text/css" href="/css/jacobsfletch.min.css")
        if user && user.canAccessKeystone
            link(href="/keystone/styles/content/editor.min.css" rel="stylesheet")
        block css
        block head
    body
        block intro
        input#dock(type='checkbox')
        input#explore(type='checkbox')
        input#filter(type='checkbox')
        input#portfolio(type='checkbox')
        .app-main
            header.app-header
                .wrapper
                    a.app-title(href='/')
                        h1 jacobsfletch
                    label.tool-toggle(for='dock')
                        .tool-media
                            +lightSwitch()
            footer.app-footer
                .container-dock
                    .container-header
                        .container-title
                            p this website is 100% handmade
                    .container-body
                        nav.menu-vertical
                            ul.menu-body
                                each link in navLinks
                                    li.menu-body-part.btn-main(class=(section == link.key ? 'active' : null))
                                        a.btn-title(target=link.target href=link.href)= link.label
                                            |  >
                        nav.menu-vertical
                            .menu-header
                                .menu-title
                                    h6 coming soon
                            ul.menu-body
                                li.menu-body-part.btn-main
                                    a.btn-title my blog
                                li.menu-body-part.btn-main
                                    a.btn-title my shop
            .app-body
                block appBody
        // script(src='/js/jacobsfletch.min.js')
        script.
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-72591985-3', 'auto');
            ga('send', 'pageview');

            scrollAnimate = function(screenElement, startElement, checkboxElement) {
                // Query Elements
                var screenEl = document.getElementById(screenElement);
                var panelBody = document.getElementById('panelBody');
                var startEl = document.getElementById(startElement);
                var scrollerContainer = document.getElementsByClassName('container-scroller')[0];
                var utilityScroller = scrollerContainer.getElementsByClassName('utility-scroller')[0];                
                var scrollerTitle = scrollerContainer.getElementsByClassName('utility-title')[0];
                var checkbox = document.getElementById(checkboxElement);
                // Initiate Constants
                var offsetHeight = startEl.offsetHeight;
                var paddingBottom = parseInt(window.getComputedStyle(startEl, null).getPropertyValue('padding-bottom'), 10);
                var height = offsetHeight - paddingBottom;
                // Calculate Circumference
                var path = scrollerContainer.getElementsByTagName('path')[0];
                var originalWidth = parseInt(utilityScroller.getElementsByTagName('svg')[0].getAttribute('width'), 10);
                var transformedWidth = parseInt(getComputedStyle(utilityScroller).getPropertyValue('width'), 10);
                var differenceRatio = transformedWidth / originalWidth;
                var circumference = path.getTotalLength() * differenceRatio;
                // Initiate variables
                var currentPercentage = 0;
                var displacement = 0;
                var threshold = 150;
                var currentRatio = 0;
                var scrollTop = 0;

                window.addEventListener('resize', updateVariables, false);
                screenEl.addEventListener('touchend', endHandler, false);
                screenEl.addEventListener('touchcancel', endHandler, false);
                screenEl.addEventListener('scroll', scrollHandler, false);
                
                    
                function updateVariables() {
                    offsetHeight = startEl.offsetHeight;
                    paddingBottom = parseInt(window.getComputedStyle(startEl, null).getPropertyValue('padding-bottom'), 10);
                }
                
                function resetStyles() {
                    screenEl.scrollTop = 0;
                    startEl.removeAttribute('style');
                    scrollerContainer.removeAttribute('style'); // Remove panelLoader Styles
                }
                
                function initSpinner(currentRatio, scrollTop) {
                    //window.requestAnimationFrame(function() {
                        scrollerContainer.style.display = 'flex';
                        scrollerContainer.style.height = offsetHeight - scrollTop + 'px';
                        scrollerContainer.style.transform = 'translateY(' + scrollTop + 'px)';
                        path.style.strokeDasharray = circumference; // Style dash-array
                        path.style.strokeDashoffset = circumference * (1 - -currentRatio); // Style dash-offset
                        if (currentRatio > 0) {
                            currentPercentage = Math.ceil(currentRatio * 100); // Calculate Ratio Difference
                            scrollerTitle.innerHTML = "<p>" + currentPercentage + "%</p>"; // Start Percentage Count
                        }
                    //});
                }

                function scrollHandler() {
                    //setTimeout(endHandler, 3000);
                    if (!checkbox.checked) {
                    scrollTop = screenEl.scrollTop;
                        if (scrollTop >= threshold) {
                            panelBody.style.overflow = 'scroll';
                            checkbox.checked = 'true';
                            resetStyles();
                        } else if (scrollTop < 1) {
                            resetStyles();
                        } else {
                            startEl.style.visibility = 'hidden';
                            currentRatio = scrollTop / threshold;
                            initSpinner(currentRatio, scrollTop);
                        }
                    } else {
                        resetStyles();
                    }
                }

                function endHandler() {
                    if (scrollTop <= threshold) {
                        screenEl.scrollTop = 0;
                    } else {
                        resetStyles();
                    }
                }
            }

            mediaToggler = function() {
                // Init variables
                var array = [];
                // Init Element Queries
                var wallBodyPart = document.querySelectorAll('.wall-body-part');
                var toolExpand = document.querySelectorAll('.tool-expand');
                var toolShrink = document.querySelectorAll('.tool-shrink');

                shrinkMedia = function(i, array) { // Shrink the media
                    for (var j = 0; j <= array.length; j++) { // Loop through the spliced array
                        if (wallBodyPart[j] !== wallBodyPart[i]) { // Select all in array except [i]
                            wallBodyPart[j].removeAttribute('style'); // Remove styles from all except [i]
                        }
                    }
                    wallBodyPart[i].removeAttribute('style'); // Remove styles from wallBodyPart
                    toolExpand[i].removeAttribute('style'); // Remove styles from toolExpand
                    toolShrink[i].removeAttribute('style'); // Remove styles from toolShrink
                    array.splice(i, 0, i); // Splice i back into the array
                    responsiveImages();
                }

                expandMedia = function(i, array) { // Expand the media
                    array.splice(i, 1); // Splice i from the array
                    for (var j = 0; j <= array.length; j++) { // Loop through the spliced array
                        if (wallBodyPart[j] !== wallBodyPart[i]) { // Select all in array except [i]
                            wallBodyPart[j].style.display = 'none'; // Hide all except [i]
                        }
                    }
                    wallBodyPart[i].style.width = '100%'; // Full width [i]
                    wallBodyPart[i].style.marginRight = '0'; // Remove margins from [i]
                    wallBodyPart[i].style.marginLeft = '0'; // Remove margins from [i]
                    toolExpand[i].style.display = 'none'; // Hide toolExpand
                    toolShrink[i].style.display = 'block'; // Make visible toolShrink
                    responsiveImages();
                }

                for (var i = 0; i < toolExpand.length; i++) { // Loop all toolExpand elements
                    array.push(i); // Create numbered array of total toolExpand elements
                    toolExpand[i].addEventListener('click', expandMedia.bind(this, i, array)); // Add click event to toolExpand and bind index
                    toolShrink[i].addEventListener('click', shrinkMedia.bind(this, i, array)); // Add click event to toolShrink and bind index
                }
            }
            
            responsiveImages = function() {  
                
                loadImage = function() {
                    imgs = document.getElementsByTagName('img');
                    
                    resetStyles = function(i) {
                        this.removeAttribute('style');
                    }
                    
                    for (var i = 0; i < imgs.length; i++) {
                        imgs[i].style.visibility = 'hidden';
                        imgWidth = Math.ceil(parseInt(window.getComputedStyle(imgs[i], null).getPropertyValue('width'), 10));
                        if (imgs[i].dataset.src) {
                            imgSrc = imgs[i].dataset.src;
                            srcParse = imgSrc.split('upload/');
                            for (var j = 0; j < srcParse.length; j++) {
                                srcFirst = srcParse[0];
                                srcLast = srcParse[1];
                                newSrc = srcFirst + 'upload/w_' + imgWidth + '/' + srcLast;
                                imgs[i].addEventListener('load', resetStyles, false);
                                imgs[i].setAttribute('src', newSrc);
                            }
                        }
                    }
                }
                
                window.addEventListener('resize', loadImage, false);

                loadImage();
                
            }
            
            loaderAnimate = function() {
                initLoader = function() {
                    // Query Elements
                    var loaders = document.getElementsByClassName('utility-loader');
                    // Calculate for Circumference
                    var originalWidth = parseInt(loaders[0].getElementsByTagName('svg')[0].getAttribute('width'), 10);
                    var transformedWidth = parseInt(getComputedStyle(loaders[0]).getPropertyValue('width'), 10);
                    var differenceRatio = transformedWidth / originalWidth;
                    var circumference = loaders[0].getElementsByTagName('path')[0].getTotalLength() * differenceRatio;
                    // Initiate Variables
                    var dashLength = parseInt(getComputedStyle(loaders[0]).getPropertyValue("stroke-dasharray"), 10); // Parse Two Decimals In, Double to Accomodate Both Sides of Circle
                    var difference = circumference - dashLength;
                    var ticker = circumference;
                    
                    startLoader = function(firstLoader, callback) {
                        for (i = 0; i < loaders.length; i++) {
                            loaders[i].style.strokeDasharray = dashLength + ',' + difference;
                            loaders[i].style.strokeDashoffset = ticker;
                        }
                        firstLoader.addEventListener('transitionend', callback);
                    }
                    
                    finishLoader = function() {
                        ticker = ticker + circumference;
                        startLoader(loaders[0], finishLoader);
                    }
                    
                    startLoader(loaders[0], finishLoader);
                    
                }
                initLoader();
            }
            
        block js
