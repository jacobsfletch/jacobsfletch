language: none
env:
    global:
      - EB_APPLICATION="[APPLICATION]"
      - EB_ENVIRONMENT="dev"
      - EB_REGION="us-west-2"
      - ECR_IMAGE="507415273238.dkr.ecr.us-west-2.amazonaws.com/[APPLICATION_ECR]"
      - ECR_TAG="$BRANCH.$BUILD_NUMBER"
      - LANG="en_US.UTF-8"
      - LANGUAGE="en_US"
      - LC_ALL="C"

build:
    pre_ci:
      - docker build -t $ECR_IMAGE:$BRANCH.$BUILD_NUMBER .
    # Use the docker image we just built for the build container for running tests.
    pre_ci_boot:
        image_name: $ECR_IMAGE
        image_tag: $BRANCH.$BUILD_NUMBER
        pull: false
    # Use the docker image we just built for the build container for running tests.
    ci:
      #- bash /usr/setup.sh
    post_ci:
      - if [ "$IS_RELEASE" = true ] && [ "$IS_PULL_REQUEST" = false ]; then ECR_TAG="$RELEASE_NAME.$BUILD_NUMBER"; fi
      - docker push $ECR_IMAGE:$ECR_TAG
      - pip install --upgrade botocore

integrations:
    hub:
      - integrationName: ecr-push
        type: ecr
        region: us-west-2
    deploy:
      - integrationName: eb-deploy
        type: aws
        application_name: "$EB_APPLICATION"
        env_name: $EB_ENVIRONMENT
        region: $EB_REGION
        image_name: $ECR_IMAGE
        image_tag: $ECR_TAG
    notifications:
      - integrationName: Shippable-Slack
        type: slack
        recipients:
          - "#tests"
        on_succes: always
        on_failure: always
        on_start: never
        on_pull_request: never
